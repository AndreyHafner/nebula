<?xml version="1.0" encoding="UTF-8"?>
<!-- 
/*******************************************************************************
 * Copyright (c) 2007 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    rmcamara@us.ibm.com - initial build setup
 *******************************************************************************/ 
 -->
<project name="org.eclipse.nebula.masterbuild" default="publish" basedir=".">
    
    <!-- Add antcontrib library to provide if/else structure -->
    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>
    
    <!-- Location of the scratch directory that can be used be individual builds. -->
    <property name="nebula.build.temp" value="../../build.temp"/>
    <!-- root directory of the nebula plugins (cvs root) -->
    <property name="nebula.plugins" value="../../org.eclipse.swt.nebula"/>
    <!-- Location relative to a plugin that build results should be put in. -->
    <property name="nebula.build.output" value="../../nebula.build"/>
    
	<!--
	    This is the master build script for Nebula.  
	    
	    To add your component to the master build:
	    1. Follow instructions in ADD_README.txt
	    2. Update the buildall target in this file, duplicate the antcall task specifying
	    your component.	    
	    -->
    <target name="buildall" depends="init">
        <antcall target="buildcomponent">
            <param name="component" value="org.eclipse.nebula.widgets.grid"/>
        </antcall>
    </target>
    
    <target name="publish" depends="buildall" description="Uploads all build zips to the eclipse server.">
        <tstamp/>
        <sshexec host="download1.eclipse.org" username="cgross"
            password="${password}" trust="yes" failonerror="no"
            command="mkdir downloads/technology/nebula/${DSTAMP}"/>
    	<!-- Upload to a timestamped directory -->
        <scp trust="yes"
            todir="cgross:${password}@download1.eclipse.org:downloads/technology/nebula/${DSTAMP}/">
            <fileset dir="${nebula.build.output}">
                <include name="*.zip"/>
            </fileset>
        </scp>
    	<!-- Overwrite the locaiton of the current distribution. -->
        <scp trust="yes"
            todir="cgross:${password}@download1.eclipse.org:downloads/technology/nebula/">
            <fileset dir="${nebula.build.output}">
                <include name="*.zip"/>
            </fileset>
        </scp>
    </target>
	
    <target name="buildcomponent">
        <delete dir="${nebula.build.temp}"/>
        <mkdir dir="${nebula.build.temp}"/>
        <if>
            <available file="${nebula.plugins}/${component}/nebula_build.xml"
                property="nebula.build.override"/>
            <then>
            	<ant antfile="nebula_build.xml" dir="${nebula.plugins}/${component}"/>
            </then>
            <else>
                <ant antfile="build.xml" target="build.update.jar"
                    dir="../${component}"/>
                <loadproperties
                    srcfile="${nebula.plugins}/${component}/nebula.properties"/>
                <antcall target="javadoc" inheritrefs="true">
                    <param name="component" value="${component}"/>
                </antcall>
                <antcall target="snippets" inheritrefs="true"/>
                <antcall target="zip" inheritrefs="true">
                    <param name="component" value="${component}"/>
                </antcall>
            </else>
        </if>
    </target>
    
	<target name="init" depends="clean">
	        <mkdir dir="${nebula.build.output}"/>
	        <cvs cvsroot=":pserver:anonymous@dev.eclipse.org:/cvsroot/technology"
	            package="org.eclipse.swt.nebula/"
	            dest="../../"/>
	</target>
	    
	    <target name="clean">
	        <delete dir="${nebula.build.output}"/>
	        <delete dir="${nebula.build.temp}"/>
	    </target>
	
	<!-- The following targets are used by the build to provide the default compile, 
		 javadoc, snippet and zip a nebula widget.  
	-->
    <target name="javadoc">
        <javadoc destdir="${nebula.build.temp}/javadoc"
            packagenames="${javadoc.packages}"
            excludepackagenames="${javadoc.exclude}"
            sourcepath="${nebula.plugins}/${component}/src"/>
    </target>
    
    <target name="snippets">
        <cvs cvsroot=":pserver:anonymous@dev.eclipse.org:/cvsroot/technology"
            package="org.eclipse.swt.nebula/org.eclipse.swt.nebula.snippets/src/${snippets.path}"
            dest="${nebula.build.temp}/temp"/>
        
        <copy todir="${nebula.build.temp}/snippets">
            <fileset
                dir="${nebula.build.temp}/temp/org.eclipse.swt.nebula/org.eclipse.swt.nebula.snippets/src/${snippets.path}"/>
        </copy>
        
        <delete dir="${nebula.build.temp}/temp"/>
    </target>
    
    <target name="zip">
        <tstamp/>
        <zip
            destfile="${nebula.build.output}/${component}_1.0_ALPHA_NIGHTLY.zip">
            <zipfileset dir="../${component}/src" prefix="src"/>
            <zipfileset includesfile="../${component}/${component}_1.0.0.jar"/>
            <zipfileset dir="${nebula.build.temp}/javadoc" prefix="javadoc"/>
            <zipfileset dir="${nebula.build.temp}/snippets" prefix="snippets"/>
        </zip>
    </target>
</project>